#+TITLE: org-parser – Dokumentation
#+OPTIONS: toc:t num:nil


* Was ist das?
=org-parser= ist ein kleiner, streaming-basierter Org-Reader + minimaler Org→HTML Exporter.

Ich habe ihn geschrieben, um meine ORG-Dateien auch von Geräten aus bequem anschauen zu können, auf denen ich Emacs nicht installieren kann.

Bausteine:
- =org_reader.py=: liest Org-Dateien zeilenweise und expandiert =#+INCLUDE= depth-first
- =org_parser.py=: Streaming-Parser, der Events (=OrgEvent=) erzeugt
- =org_to_html.py=: minimaler Renderer (Headings, Paragraphen, Listen, Tabellen, Blöcke, Comments/noexport, Inline-Markup, Inline-Math)
- =webapp.py=: Flask-Webviewer (Listet README + org/*.org, liefert /assets und /math)
- =math_renderer.py=: rendert Inline-Math über LaTeX + dvisvgm in SVG (Cache)

Wichtige Designziele:
- streaming / lazy iteration (kein komplettes File im RAM nötig)
- “gute genug” Org-Unterstützung für deine Dokumente & Demos
- klarer State (=OrgState=) + Events (=OrgEvent=) als Pipeline

* Installation & Betrieb
** Option A: Lokal (system Python)
Voraussetzungen:
- Python ≥ 3.12 empfohlen (du nutzt lokal sogar 3.14)
- für Math-SVG: =latex= und =dvisvgm= im PATH

Minimal:
#+begin_src bash :results verbatim
python3 -m venv .venv
source .venv/bin/activate
python -m pip install -U pip
python -m pip install flask gunicorn pyyaml
#+end_src

** Option B: Lokal mit =uv=
#+begin_src bash :results verbatim
uv venv
source .venv/bin/activate
uv pip install flask gunicorn pyyaml
#+end_src

** Option C: Container (Podman/Docker)
Du baust ein Image und startest es mit (podman-)compose.
Vorteil: reproduzierbar + kein “Python-Setup” auf dem Host.

*** Build
#+begin_src bash :results verbatim
podman build -t org-viewer:latest -f Containerfile .
#+end_src

*** Run (Compose)
#+begin_src bash :results verbatim
podman-compose up -d
podman logs -f org-viewer
#+end_src

** TLS-Optionen

*** 1) TLS im Container (Gunicorn mit --certfile/--keyfile)
- Cert/Key als Volume nach /certs mounten
- ENV: CERT_FILE und KEY_FILE setzen

*** 2) TLS via Reverse Proxy (empfohlen)
Container läuft HTTP intern, davor Caddy/Nginx/Traefik.

** Math-Cache & Permissions (wichtig!)
Der Renderer schreibt nach =/app/.math-cache=.

Wenn du bind-mountest:
- verwende Podman-Option =:U=, damit Ownership im Container passt
- und bei SELinux =:Z=

Beispiel:
=./.math-cache:/app/.math-cache:rw,Z,U=

Das ist besser als =chmod 777= auf dem Host.

* Nutzung (CLI / Export / Web)
** 1) Includes expandieren (Debug)
#+begin_src bash :results verbatim
python3 org_reader.py
#+end_src

** 2) Org → HTML exportieren
#+begin_src bash :results verbatim
python3 org_to_html.py org/90-feature-demo.org -o out.html
#+end_src

** 3) Webviewer starten (lokal)
#+begin_src bash :results verbatim
python3 webapp.py
# dann: http://localhost:5000
#+end_src

** 4) Webviewer via Gunicorn
HTTP:
#+begin_src bash :results verbatim
gunicorn -w 4 -b 0.0.0.0:5000 webapp:app
#+end_src

TLS:
#+begin_src bash :results verbatim
gunicorn -w 4 -b 0.0.0.0:5000 webapp:app --certfile /certs/tls.crt --keyfile /certs/tls.key
#+end_src

* API-Referenz
** Module: config_loader.py

*** Klasse: OrgReaderConfig
Container für Regex + Parser-Settings.

Felder (Auszug):
- verbatim_blocks: set[str]
- skip_header_keys: set[str]
- quotes: dict[str,str]
- block_re, header_kv_re, include_keyword_re, section_heading_re, …
- comment_begin_re, comment_end_re
- latex_macro_re

*** DEFAULT_CONFIG
Default-Konfiguration inkl. Regex (compiled).

*** load_config(path: Path) -> OrgReaderConfig
Liest YAML (config.yml) und erzeugt eine OrgReaderConfig-Instanz.
** Module: org_parser.py

*** Dataclasses
- OrgEvent(type: str, data: dict[str, Any])
- OrgPreamble(headers: dict[str,str]) + Properties: title/author/date/options
- OrgState (mutable streaming state)

*** Wichtige Funktionen
- parse_org_line(line, cfg, state) -> (state, events)
  Erzeugt Events (heading, block_begin/end, src_begin/end, list_item, table_row, …)

- tokenize_inline_org_markup(text) -> list[(type,text)]
  Minimale Inline-Tokens:
  - plaintext, bold_text, italic_text, code
  - link (packed url/desc)
  - math_inline (für \(..\) und $..$)

- parse_src_block_options(arg_string) -> dict[str,str]
  Liest “language + header args” aus begin_src-Zeile.

- parse_html_attr_args(arg_string) -> dict[str,str]
  Liest #+ATTR_HTML: …

*** Events (aktuell)
- preamble_kv, preamble_end
- heading
- block_begin, block_end
- src_begin, src_end
- list_item, ordered_list_item
- table_row, table_hline, tblfm
- name, caption, attr_html
- comment, comment_block
- latex_macro
- line_tokens (debug/renderer input)
** Module: org_reader.py

*** Funktionen
- un_quote_string(string, cfg) -> str
- resolve_include(line, path, cfg) -> Path
- is_include(line, cfg) -> bool
- should_skip_header_line(line, cfg) -> bool
- preamble_decision(line, cfg) -> (skip: bool, still_in_preamble: bool)
- read_with_includes(path, cfg, *, is_root=True) -> Iterator[str]

*** read_with_includes – Regeln
- depth-first Include-Expansion
- keine Expansion innerhalb:
  - Blocks (=state.is_inside_block=)
  - Drawers
  - Comment-Blöcken
- bei included files: “preamble skip” bis erster echter Content (deine Logik)
** Module: org_to_html.py

*** Hauptfunktionen
- render_org_to_html_document(input_path, cfg) -> str
- org_to_html(input_path, output_path, cfg) -> None

*** Rendering-Features (aktuell)
- Headings h1..h6 + tags
- Paragraphen
- Unordered/Ordered lists
- Verbatim Blocks + src blocks (data-language + data-*)
- Inline Markup (bold/italic/code/links)
- Image-only lines -> <figure> mit caption + ATTR_HTML
- Tables + subset TBLFM
- Comments + comment blocks als einklappbarer Bereich
- :noexport: headings: wie comment behandeln (einklappbar)
- Verse block als eigener Container (Zeilenumbrüche erhalten)
- Inline Math: $..$ / \(..\) -> SVG via /math/<digest>.svg

*** Wichtige interne Helfer (stabiler “API” Charakter)
- render_inline_tokens(tokens, *, preamble_macros="") -> str
- flush_paragraph(..., preamble_macros="") -> None
- math_image_url(math_src, *, preamble_macros="") -> str
** Module: math_renderer.py
- render_math_to_svg(math_src, out_path, *, preamble_macros="") -> None
  schreibt temporäres standalone-LaTeX, dann latex->dvi->dvisvgm->svg

** Module: webapp.py
- index(): listet README.org + org/*.org
- view_file(filename): rendert Org→HTML
- assets(subpath): served /assets/...
- math_image(digest): erzeugt SVG on-demand aus Cache

Wichtig:
- Math-Cache muss writable sein: /app/.math-cache
- im Container: Volume mount mit :Z,U empfohlen

* Troubleshooting
** “Permission denied: .math-cache/*.tex”
Ursache: Container-User kann in den bind-mount nicht schreiben.

Fix (Podman):
- nutze :U bei dem Volume:
  =./.math-cache:/app/.math-cache:rw,Z,U=
- vermeide chmod 777 (geht, aber unschön)

** curl “Empty reply” / “unexpected eof”
- du sprichst HTTPS an, aber Container läuft HTTP (oder andersrum)
- check:
  podman logs org-viewer
  ss -tlpn | grep 5000
  curl http://localhost:5000

** TLS disabled (no cert/key found)
- CERT_FILE / KEY_FILE passen nicht
- certs volume gemountet?
- Pfade im Container prüfen: ls -al /certs

* Feature-Demo / Regression-Test
Siehe: [[file:90-feature-demo.org][90-feature-demo.org]]
